@inject IRepositorioMateriales _repositoriomaterial

<div>
    <div class="mb-2 d-flex justify-content-between align-items-center">
        <strong>Materiales</strong>
        <button class="btn btn-sm btn-outline-success" @onclick="StartAdd">Añadir</button>
    </div>

    <div class="mb-2">
        <button class="btn btn-sm btn-outline-success" @onclick="StartAdd">Añadir</button>
    </div>

    <ul class="list-group mb-3">
        @foreach (var m in _materiales)
        {
            <li class="list-group-item d-flex justify-content-between align-items-center">
                @m.Nombre
                <div>
                    <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => Edit(m)">Editar</button>
                    <button class="btn btn-sm btn-outline-danger" @onclick="() => Delete(m.Id)">Eliminar</button>
                </div>
            </li>
        }
    </ul>

    @if (_isAdding || _isEditing)
    {
        <EditForm Model="_editing" OnValidSubmit="Save">
            <DataAnnotationsValidator />
            <InputText class="form-control mb-2" @bind-Value="_editing.Nombre" />
            <div>
                <button type="submit" class="btn btn-sm btn-success">Guardar</button>
                <button type="button" class="btn btn-sm btn-secondary ms-2" @onclick="Cancel">Cancelar</button>
            </div>
        </EditForm>
    }
</div>

@code {
    private List<Materiale> _materiales = new();
    private Materiale _editing = new();
    private bool _isAdding;
    private bool _isEditing;

    [Parameter]
    public EventCallback<bool> OnChanged { get; set; } // notifica al padre cuando hay cambios

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    public async Task Load()
    {
        _materiales = await _repositoriomaterial.GetAll();
    }

    private void StartAdd()
    {
        _editing = new Materiale();
        _isAdding = true;
        _isEditing = false;
    }

    private void Edit(Materiale m)
    {
        _editing = new Materiale { Id = m.Id, Nombre = m.Nombre };
        _isEditing = true;
        _isAdding = false;
    }

    private async Task Save()
    {
        if (_isEditing)
            await _repositoriomaterial.Update(_editing.Id, _editing);
        else
            await _repositoriomaterial.Add(_editing);

        _isAdding = _isEditing = false;
        _editing = new Materiale();
        await Load();
        await OnChanged.InvokeAsync(true);
    }

    private void Cancel()
    {
        _isAdding = _isEditing = false;
        _editing = new Materiale();
    }

    private async Task Delete(int id)
    {
        await _repositoriomaterial.Delete(id);
        await Load();
        await OnChanged.InvokeAsync(true);
    }
}