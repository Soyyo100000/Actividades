@page "/personas/nueva"
@page "/personas/editar/{Id:int}"
@rendermode InteractiveServer
@inject NavigationManager _navigator;
@inject IRepositorioPersonas _repositorio;
@inject IRepositorioClasificacion _repositorioclas;
@inject IRepositorioMateriales _repositoriomaterial;

<h2>@_mensaje Persona</h2>

<EditForm Model="_persona" FormName="frmPersona" OnValidSubmit="Guardar">
    <DataAnnotationsValidator />

    <div class="row mb-3">
        <label for="txtNombre" class="col-2 col-form-label">Nombre</label>
        <div class="col-10">
            <InputText id="txtNombre" class="form-control" @bind-Value="_persona.Nombre" />
            <ValidationMessage For="() => _persona.Nombre" />
        </div>
    </div>

    <div class="row mb-3">
        <label for="txtCorreo" class="col-2 col-form-label">Correo</label>
        <div class="col-10">
            <InputText id="txtCorreo" class="form-control" @bind-Value="_persona.Correo" />
            <ValidationMessage For="() => _persona.Correo" />
        </div>
    </div>

    <div class="row mb-3">
        <label for="txtTelefono" class="col-2 col-form-label">Teléfono</label>
        <div class="col-10">
            <InputText id="txtTelefono" class="form-control" @bind-Value="_persona.Telefono" />
            <ValidationMessage For="() => _persona.Telefono" />
        </div>
    </div>

    <!-- Clasificación + botones -->
    <div class="row mb-3">
        <label class="col-2 col-form-label">Clasificación</label>
        <div class="col-6">
            <InputSelect class="form-select" @bind-Value="_persona.ClasificacionId">
                <option value="0">-- Seleccione clasificación --</option>
                @foreach (var c in _clasificaciones)
                {
                    <option value="@c.Id">@c.Nombre</option>
                }
            </InputSelect>
            <ValidationMessage For="() => _persona.ClasificacionId" />
        </div>
        <div class="col-4 d-flex">
            <button type="button" class="btn btn-sm btn-success me-2" @onclick='() => _navigator.NavigateTo("/clasificaciones")'>Nueva</button>
            <button type="button" class="btn btn-sm btn-primary me-2" @onclick='() => _navigator.NavigateTo($"/clasificaciones/editar/{_persona.ClasificacionId}")' disabled="@(_persona.ClasificacionId == 0)">Editar</button>
            <button type="button" class="btn btn-sm btn-danger" @onclick='() => _navigator.NavigateTo($"/clasificaciones/editar/{_persona.ClasificacionId}?delete=true")' disabled="@(_persona.ClasificacionId == 0)">Eliminar</button>
        </div>
    </div>

    <!-- Materiales: checkboxes para seleccionar varios + selector para editar/eliminar -->
    <div class="row mb-3">
        <label class="col-2 col-form-label">Materiales</label>
        <div class="col-6">
            @if (_materiales == null || !_materiales.Any())
            {
                <div>No hay materiales.</div>
            }
            else
            {
                @foreach (var m in _materiales)
                {
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="mat@m.Id"
                               checked="@IsMaterialSelected(m.Id)"
                               @onchange="@( (ChangeEventArgs e) => ToggleMaterialAsync(e, m.Id) )" />
                        <label class="form-check-label" for="mat@m.Id">@m.Nombre</label>
                    </div>
                }
            }
        </div>

        <div class="col-4 d-flex flex-column">
            <label class="form-label">Gestionar materiales</label>
            <div class="input-group mb-2">
                <select class="form-select" @bind="_materialSeleccionadoId">
                    <option value="0">-- Seleccionar material --</option>
                    @foreach (var m in _materiales)
                    {
                        <option value="@m.Id">@m.Nombre</option>
                    }
                </select>
            </div>
            <div class="d-flex">
                <button type="button" class="btn btn-sm btn-success me-2" @onclick='() => _navigator.NavigateTo("/materiales")'>Nuevo</button>
                <button type="button" class="btn btn-sm btn-primary me-2" @onclick='() => _navigator.NavigateTo($"/materiales/editar/{_materialSeleccionadoId}")' disabled="@(_materialSeleccionadoId == 0)">Editar</button>
                <button type="button" class="btn btn-sm btn-danger" @onclick="DeleteMaterialAndRefresh" disabled="@(_materialSeleccionadoId == 0)">Eliminar</button>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-2"></div>
        <div class="col-10">
            <small class="text-muted">Marca los materiales que correspondan para asociarlos con la persona.</small>
        </div>
    </div>

    <div class="d-flex">
        <button type="submit" class="btn btn-primary me-3">Guardar Persona</button>
        <button class="btn btn-danger" @onclick="Cancelar" @onclick:preventDefault>Cancelar</button>
    </div>
</EditForm>

@code {
    [Parameter] public int Id { get; set; }

    private string _mensaje = "";
    private Persona _persona = new();
    private List<Clasificacion> _clasificaciones = new();
    private List<Materiale> _materiales = new();

    // Selección many-to-many
    private HashSet<int> _selectedMaterialIds = new();

    // selector único para editar/eliminar material
    private int _materialSeleccionadoId = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadClasificaciones();
        await LoadMateriales();

        if (Id > 0)
        {
            _persona = (await _repositorio.Get(Id)) ?? new Persona();
            _mensaje = "Modificar";
            if (_persona.Materiales != null)
                _selectedMaterialIds = _persona.Materiales.Select(m => m.Id).ToHashSet();
        }
        else
        {
            _mensaje = "Nueva";
            _persona = new Persona();
        }
    }

    private async Task LoadClasificaciones() => _clasificaciones = await _repositorioclas.GetAll();
    private async Task LoadMateriales() => _materiales = await _repositoriomaterial.GetAll();

    private bool IsMaterialSelected(int id) => _selectedMaterialIds.Contains(id);

    private Task ToggleMaterialAsync(ChangeEventArgs e, int materialId)
    {
        var isChecked = e?.Value is bool b && b;
        if (!isChecked && e?.Value is string s && s == "on") isChecked = true;

        if (isChecked) _selectedMaterialIds.Add(materialId);
        else _selectedMaterialIds.Remove(materialId);

        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task Guardar()
    {
        // Asociar materiales seleccionados
        _persona.Materiales = _materiales.Where(m => _selectedMaterialIds.Contains(m.Id)).ToList();

        if (Id > 0)
            await _repositorio.Update(Id, _persona);
        else
            await _repositorio.Add(_persona);

        Cancelar();
    }

    private void Cancelar() => _navigator.NavigateTo("/personas");

    private async Task DeleteMaterialAndRefresh()
    {
        if (_materialSeleccionadoId == 0) return;

        await _repositoriomaterial.Delete(_materialSeleccionadoId);
        _materialSeleccionadoId = 0;
        // limpiar selección si estaba marcada
        if (_selectedMaterialIds.RemoveWhere(id => id == _materialSeleccionadoId) > 0) { }
        await LoadMateriales();
        StateHasChanged();
    }
}